# dentalemr-ws-service
A websocket (SignalR) Windows service


# DemrService
A Windows Service / Console Windows/win32 app that hosts a Kestrel websocket (SignalR) server that

1. Invokes Windows programs.
2. Returns file bytes from Windows or Zips up directory and returns zip bytes from Windows.

## DEMR Service (SignalR)

### Endpoints: 

    1. `http://127.0.0.1:5000/demr` 
    2. `https://127.0.0.1:5001/demr`, with the latter configured with a self-signed cert. This endpoint is required by Firefox when the Origin is https, but not in Chrome.

### CORS configuration

Allows origins: 
(https://github.com/DentalEMR/dentalemr-ws-service/blob/master/DemrService/Startup.cs#L36): 
- "https://localhost:44326" - for TestWebApp (below)
- "https://app.dentaledr.com", 
- "https://app.dentalemr.com"

### Methods:

- `BinaryExecuter(binaryPath, binaryArgs, transactionId)` that synchronously (one call to method until completion at a time in sequence) executes the binary at `binarPath` with `binaryArgs` and calls one of the two following client methods once the binary has completed execution:
- `BinaryExecuterAsync(binaryPath, binaryArgs, transactionId)` that asynchronously (more than one call to method runs in parallel) executes the binary at `binarPath` with `binaryArgs` and calls one of the two following client methods once the binary has completed execution:
    1. InvokeBinarySucceeded (exitCode, binaryStdOut, binaryStdErr, transactionId)

- `RetrieveFileAndPost(path, isDir, url, transactionId)` that synchronously zips the directory at `path` and uploads to `url` if `isDir` is true, else uploads the file at `path` to `url` and sends either:
- `RetrieveFileAndPostAsync(path, isDir, url, transactionId)` that asynchronously zips the directory at `path` and uploads to `url` if `isDir` is true, else uploads the file at `path` to `url` and sends either:
    1. RetrieveFileAndPostFailed(tatusCode, reasonPhrase, transactionId) or
    2. RetrieveFileAndPostSucceeded(content, transactionId)

## File retriever

    1. InvokeBinaryExceptioned(ex.Message, transactionId)
- `HTTP GET: /api/RetrieveFile?path=<PATH>&isdir=false` where `path` is path of file to return if `isdir` is `false` or directory to zip and return if `isdir` is `true`.


# Build & Deployment

## Build Commands

### Single-File Self-Contained Deployment
**Output**: Single `DemrService` executable (~95MB)
**Requirements**: No runtime needed, single file for easy distribution

### Cross-Platform Builds
```bash
# For Windows
dotnet publish -c Release -r win-x64 --self-contained true -p:PublishSingleFile=true

# For Linux
dotnet publish -c Release -r linux-x64 --self-contained true -p:PublishSingleFile=true

# For macOS
dotnet publish -c Release -r osx-x64 --self-contained true -p:PublishSingleFile=true
```

## Installation

### Automated Installation (Recommended)
1. Build using one of the commands above
2. For single-file: Copy the `DemrService` executable to target machine
3. For multi-file: Copy entire `publish/` folder to target machine
4. Copy `demrservice.pfx` certificate file
5. Install certificate and run executable

### Manual Installation (Legacy)
1. From within Visual Studio, publish 'DemrService' project AND 'demrservice.pfx' to 'publish' folder.
2. Zip / unzip 'publish' folder onto integration computer.
3. Double click 'demrservice.pfx' on integration computer and install certificate (required by Chrome but not Firefox for some reason)
4. In both Chrome and Firefox, navigate a browser tab to https://127.0.0.1:5001 and in warning select advanced and add exception.
5. Double click 'DemrService' executable to run in console window. Ctrl-c exits program. Can be installed as a service but this hasn't been configured yet.

# Test applications

## TestConsoleApp 
A simple console app that accepts arguments and outputs a string including arguments to stdout.

## TestWebApp
An example SignalR websocket client implementation that reliably reconnects. SEE https://github.com/DentalEMR/dentalemr-ws-service/blob/master/TestWebApp/wwwroot/js/app.js .

# Implementation Notes

- demrservice.pfx was generated by exporting the development self-signed certificate.

# Copyright 
DentalEMR, Inc. All rights reserved.
